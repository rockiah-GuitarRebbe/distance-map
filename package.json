# ==============================
# package.json
# ==============================
{
  "name": "distance-viewer",
  "private": true,
  "type": "module",
  "engines": { "node": ">=18" },
  "scripts": { "start": "node server.mjs" },
  "dependencies": {
    "express": "^4.19.2",
    "socket.io": "^4.7.5"
  }
}

# ==============================
# server.mjs
# ==============================
import express from "express";
import http from "http";
import { Server } from "socket.io";
import path from "path";
import fs from "fs";
import { fileURLToPath } from "url";

const app = express();
const server = http.createServer(app);
const io = new Server(server, {
  cors: { origin: "*", methods: ["GET", "POST"] },
  transports: ["websocket"],
});

const PORT = process.env.PORT || 3000;
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ---- static
app.use(express.static(__dirname));
app.get("/", (_, res) => res.sendFile(path.join(__dirname, "index.html")));

// ---- storage
const DATA_FILE = path.join(__dirname, "workers.json");
/** @type {{name:string,address:string,lat:number,lng:number,level?:string}[]} */
let workers = [];
if (fs.existsSync(DATA_FILE)) {
  try { workers = JSON.parse(fs.readFileSync(DATA_FILE, "utf8")); } catch { workers = []; }
}
function saveWorkers() {
  try { fs.writeFileSync(DATA_FILE, JSON.stringify(workers, null, 2)); } catch {}
}

// ---- helpers
const LEVELS = new Set(["critical","high","medium","low"]);
const normLevel = (v) => (LEVELS.has(String(v||"").toLowerCase()) ? String(v).toLowerCase() : "low");

function sanitizeWorker(w) {
  const name = String(w?.name ?? "").trim();
  const address = String(w?.address ?? "").trim();
  const lat = Number(w?.lat), lng = Number(w?.lng);
  const level = normLevel(w?.level);
  if (!name || !address) return null;
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
  // US-ish bounds guard (keeps junk out)
  if (lat < 18 || lat > 73 || lng < -180 || lng > -50) return null;
  return { name, address, lat, lng, level };
}
const keyFor = (w) => `${w.name.toLowerCase()}|${w.address.toLowerCase()}|${normLevel(w.level)}`;

// simple per-socket rate limiter (why: avoid floods)
function makeLimiter(maxOps, windowMs) {
  let ops = 0, start = Date.now();
  return () => {
    const now = Date.now();
    if (now - start > windowMs) { start = now; ops = 0; }
    ops += 1;
    return ops <= maxOps;
  };
}

// ---- endpoints
app.get("/healthz", (_, res) => res.status(200).json({ ok: true, count: workers.length }));
app.get("/api/workers", (_, res) => res.json(workers.map(w => ({ ...w, level: normLevel(w.level) }))));

// ---- sockets
io.on("connection", (socket) => {
  const allow = makeLimiter(50, 2000); // 50 ops / 2s
  socket.emit("curren
