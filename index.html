<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shared Distance Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: system-ui, Arial, sans-serif;
      height: 100vh;
    }
    .sidebar {
      width: 28%;
      min-width: 300px;
      background: #f8f9fa;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #map {
      flex: 1;
      height: 100vh;
    }
    header {
      padding: 10px;
      background: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      background: #0078d4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #005fa3;
    }
    .delete-btn {
      background: transparent;
      color: #d33;
      font-size: 18px;
      cursor: pointer;
      padding: 0 4px;
    }
    .delete-btn:hover {
      color: #a00;
      transform: scale(1.1);
    }

    /* table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    tr:nth-child(even) {
      background: #f2f2f2;
    }
    tr:hover {
      background: #e9f3ff;
    }
    td.distance {
      text-align: right;
      font-weight: 600;
    }
    .dist-green { color: #27ae60; }
    .dist-yellow { color: #f39c12; }
    .dist-red { color: #e74c3c; }
  </style>
</head>
<body>
  <div class="sidebar">
    <header>
      <h3>Clients</h3>
      <div>
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" />
        <button id="uploadExcelBtn">üìÇ Excel</button>
        <button id="clearListBtn" style="background:#e74c3c;">üßπ Clear</button>
      </div>
    </header>

    <div style="padding:10px;border-bottom:1px solid #ddd;">
      <label><b>Therapist Location:</b></label><br />
      <input id="therapistInput" placeholder="Enter ZIP or address" style="width:90%;padding:6px;" />
      <div style="margin-top:6px;display:flex;gap:5px;">
        <button id="therapistBtn">üìç Show</button>
        <button id="clearTherapistBtn" style="background:#888;">üßç‚Äç‚ôÄÔ∏è Clear</button>
      </div>
    </div>

    <div style="padding:6px;font-size:13px;color:#555;border-bottom:1px solid #ddd;text-align:center;">
      Distances update when therapist is set.
    </div>

    <div style="overflow-y:auto;flex:1;">
      <table id="clientTable">
        <thead>
          <tr><th>Name</th><th>Address</th><th>Distance (mi)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div id="map"></div>

  <script>
    const socket = io(window.location.origin, { transports: ["websocket","polling"] });
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = [];
    let therapistMarker = null;
    let therapistLoc = null;

    function distanceMiles(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function getColorClass(mi){
      if (mi < 10) return "dist-green";
      if (mi < 50) return "dist-yellow";
      return "dist-red";
    }

    function updateTable(){
      const tbody = document.querySelector("#clientTable tbody");
      tbody.innerHTML = "";
      markers.forEach(m=>{
        const tr = document.createElement("tr");
        tr.onclick = ()=>{
          map.setView(m.latlng, 10);
          L.popup().setLatLng(m.latlng).setContent(`<b>${m.name}</b><br>${m.address}`).openOn(map);
        };
        const tdName = document.createElement("td");
        tdName.textContent = m.name;
        const tdAddr = document.createElement("td");
        tdAddr.textContent = m.address.split(",")[0];
        const tdDist = document.createElement("td");
        tdDist.className = "distance";
        if (therapistLoc && m.latlng){
          const d = distanceMiles(therapistLoc.lat, therapistLoc.lon, m.latlng.lat, m.latlng.lng);
          tdDist.textContent = d.toFixed(1);
          tdDist.classList.add(getColorClass(d));
        } else tdDist.textContent = "‚Äî";
        tr.append(tdName, tdAddr, tdDist);
        tbody.append(tr);
      });
    }

    function addWorker(worker, broadcast=true) {
      if (markers.some(m => m.name===worker.name && m.address===worker.address)) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&limit=1&q=${encodeURIComponent(worker.address)}`)
        .then(r=>r.json())
        .then(data=>{
          if(data.length){
            const {lat,lon}=data[0];
            markers.push({name:worker.name,address:worker.address,latlng:{lat:+lat,lng:+lon}});
            updateTable();
            if(broadcast) socket.emit("addWorker", worker);
          }
        })
        .catch(()=>console.warn("Geocode failed"));
    }

    function removeWorker(worker){
      const i = markers.findIndex(m=>m.name===worker.name&&m.address===worker.address);
      if(i>=0){ markers.splice(i,1); updateTable(); }
    }

    function setTherapistMarker(t){
      if(!t)return;
      if(therapistMarker) map.removeLayer(therapistMarker);
      therapistLoc = {lat:t.lat, lon:t.lon};
      therapistMarker = L.marker([t.lat,t.lon], {
        icon:L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",iconSize:[32,32],iconAnchor:[16,32]})
      }).addTo(map).bindPopup(`<b>Therapist</b><br>${t.display_name}`).openPopup();
      map.setView([t.lat,t.lon],7);
      document.getElementById("therapistInput").value=t.display_name;
      updateTable();
    }

    // Excel upload
    document.getElementById("uploadExcelBtn").onclick=()=>document.getElementById("excelInput").click();
    document.getElementById("excelInput").addEventListener("change",e=>{
      const f=e.target.files[0]; if(!f)return;
      const r=new FileReader();
      r.onload=ev=>{
        const wb=XLSX.read(new Uint8Array(ev.target.result),{type:"array"});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        XLSX.utils.sheet_to_json(sheet).forEach(row=>{
          const keys=Object.keys(row);
          if(keys.length>=2)addWorker({name:row[keys[0]],address:row[keys[1]]});
        });
      };
      r.readAsArrayBuffer(f);
    });

    document.getElementById("therapistBtn").onclick=async()=>{
      const q=document.getElementById("therapistInput").value.trim();
      if(!q)return alert("Enter a location first.");
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q+", USA")}`);
      const data=await res.json(); if(!data.length)return alert("Not found");
      const {lat,lon,display_name}=data[0];
      setTherapistMarker({lat,lon,display_name});
    };

    document.getElementById("clearTherapistBtn").onclick=()=>{
      if(therapistMarker){ map.removeLayer(therapistMarker); therapistMarker=null; therapistLoc=null; }
      document.getElementById("therapistInput").value="";
      updateTable();
    };

    document.getElementById("clearListBtn").onclick=()=>{
      if(!confirm("Clear all?"))return;
      markers.length=0;
      updateTable();
      socket.emit("clearAll");
    };

    socket.on("initData",({workers})=>{ workers.forEach(w=>addWorker(w,false)); });
    socket.on("workerAdded",w=>addWorker(w,false));
    socket.on("workerRemoved",w=>removeWorker(w));
    socket.on("allCleared",()=>{ markers.length=0; updateTable(); });
  </script>
</body>
</html>
