<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Distance Map ‚Äî Shared Workers</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Arial,sans-serif}
    body{display:flex;overflow:hidden}
    .sidebar{flex:0 0 22%;min-width:260px;max-width:400px;height:100vh;border-right:1px solid #ddd;background:#f8f8f8;display:flex;flex-direction:column}
    header{padding:10px;border-bottom:1px solid #ddd;background:#fafafa;display:flex;justify-content:space-between;align-items:center;gap:8px}
    #facilityList{list-style:none;margin:0;padding:10px;overflow-y:auto;flex:1}
    #facilityList li{display:flex;align-items:center;gap:6px;border-bottom:1px solid #eee;padding:4px 0;font-size:14px}
    .delete-btn{background:transparent;color:#d33;border:none;font-size:18px;cursor:pointer;padding:0 4px;line-height:1}
    .delete-btn:hover{color:#a00;transform:scale(1.1)}
    #map{flex:1 1 auto;height:100vh;width:100%}
    button{cursor:pointer;border:none;border-radius:6px;padding:6px 10px;background:#0078d4;color:#fff;font-size:14px}
    button:hover{background:#005fa3}
    #addWorkerPopup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:2px solid #ccc;border-radius:10px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.3);z-index:9999}
    #distanceResults{padding:10px;font-size:14px;overflow-y:auto;max-height:200px}
  </style>
</head>
<body>
  <div class="sidebar">
    <header>
      <h3>Loaded Workers</h3>
      <div>
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" />
        <button id="uploadExcelBtn">üìÇ Excel</button>
        <button id="addWorkerBtn">‚ûï Add</button>
        <button id="clearListBtn" style="background:#e74c3c;">üßπ Clear</button>
      </div>
    </header>

    <div style="padding:10px;border-bottom:1px solid #ddd">
      <label><b>Therapist Location:</b></label><br>
      <input id="therapistInput" placeholder="Enter city, ZIP, or address" style="width:90%;padding:6px">
      <div style="margin-top:6px;display:flex;gap:5px">
        <button id="therapistBtn">üìç Show</button>
        <button id="clearTherapistBtn" style="background:#888;">üßç‚Äç‚ôÄÔ∏è Clear Therapist</button>
      </div>
    </div>

    <div id="distanceResults"><i>No therapist selected.</i></div>
    <ul id="facilityList"></ul>
  </div>

  <div id="map"></div>

  <div id="addWorkerPopup">
    <h3>Add Worker</h3>
    <label>Name:</label><br>
    <input id="workerName" style="width:250px"><br><br>
    <label>Address:</label><br>
    <input id="workerAddress" style="width:250px"><br><br>
    <button id="saveWorkerBtn">Add</button>
    <button id="cancelWorkerBtn" style="background:#aaa;">Cancel</button>
  </div>

  <script>
  window.addEventListener("load", () => {
    const socket = io(window.location.origin, { transports: ["websocket","polling"] });
    const map = L.map("map").setView([39.8283, -98.5795], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:"¬© OpenStreetMap contributors"
    }).addTo(map);

    const markers = [];
    let therapistMarker = null;
    let cancelUpload = false;

    // Popup logic
    const popup = document.getElementById("addWorkerPopup");
    document.getElementById("addWorkerBtn").onclick = () => popup.style.display="block";
    document.getElementById("cancelWorkerBtn").onclick = () => popup.style.display="none";

    // Add manual worker
    document.getElementById("saveWorkerBtn").onclick = () => {
      const name=document.getElementById("workerName").value.trim();
      const address=document.getElementById("workerAddress").value.trim();
      if(!name||!address)return alert("Please enter both fields");
      const worker={name,address:address+", USA"};
      socket.emit("addWorker",worker);
      popup.style.display="none";
      document.getElementById("workerName").value="";
      document.getElementById("workerAddress").value="";
    };

    // Excel upload
    document.getElementById("uploadExcelBtn").onclick=()=>document.getElementById("excelInput").click();
    document.getElementById("excelInput").addEventListener("change",e=>{
      const file=e.target.files[0]; if(!file)return;
      const reader=new FileReader();
      reader.onload=evt=>{
        const data=new Uint8Array(evt.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet);
        json.forEach((row,i)=>{
          const keys=Object.keys(row); if(keys.length<2)return;
          const worker={name:row[keys[0]],address:row[keys[1]]};
          if(worker.name&&worker.address)setTimeout(()=>socket.emit("addWorker",worker),i*1000);
        });
      };
      reader.readAsArrayBuffer(file);
    });

    async function addWorkerToUI(worker){
      if(document.querySelector(`li[data-name="${worker.name}"][data-address="${worker.address}"]`))return;
      const list=document.getElementById("facilityList");
      const li=document.createElement("li");
      li.dataset.name=worker.name; li.dataset.address=worker.address;
      const del=document.createElement("button");
      del.textContent="√ó"; del.className="delete-btn";
      del.onclick=()=>socket.emit("removeWorker",worker);
      li.append(del);
      const span=document.createElement("span");
      span.textContent=`${worker.name} ‚Äî ${worker.address}`;
      li.append(span); list.append(li);
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&limit=1&q=${encodeURIComponent(worker.address)}`);
        const d=await r.json();
        if(d.length){const {lat,lon}=d[0];
          const mk=L.marker([lat,lon]).addTo(map).bindPopup(`<b>${worker.name}</b><br>${worker.address}`);
          markers.push({...worker,marker:mk}); fitAll();
        }
      }catch(e){console.error(e);}
    }

    function removeWorkerFromUI(worker){
      const li=document.querySelector(`li[data-name="${worker.name}"][data-address="${worker.address}"]`);
      if(li)li.remove();
      const idx=markers.findIndex(x=>x.name===worker.name&&x.address===worker.address);
      if(idx>=0){map.removeLayer(markers[idx].marker);markers.splice(idx,1);fitAll();}
    }

    function clearAllUI(){
      document.getElementById("facilityList").innerHTML="";
      markers.forEach(m=>map.removeLayer(m.marker));
      markers.length=0;
      if(therapistMarker){map.removeLayer(therapistMarker);therapistMarker=null;}
      document.getElementById("distanceResults").innerHTML="<i>No therapist selected.</i>";
      document.getElementById("therapistInput").value="";
      map.setView([39.8283,-98.5795],4);
    }

    function fitAll(){
      if(!markers.length)return;
      const g=new L.featureGroup(markers.map(m=>m.marker));
      map.fitBounds(g.getBounds().pad(0.3));
    }

    // Therapist logic
    document.getElementById("clearTherapistBtn").onclick=()=>clearAllUI();
    document.getElementById("clearListBtn").onclick=()=>socket.emit("clearAll");

    document.getElementById("therapistBtn").onclick=async()=>{
      const input=document.getElementById("therapistInput");
      let q=input.value.trim(); if(!q){alert("Please enter ZIP or address");return;}
      if(!/usa|united states/i.test(q))q+=", USA";
      try{
        const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&limit=1&q=${encodeURIComponent(q)}`);
        const data=await res.json(); if(!data.length)return alert("Address not found");
        const {lat,lon,display_name}=data[0]; const pos=[+lat,+lon];
        if(therapistMarker)map.removeLayer(therapistMarker);
        therapistMarker=L.marker(pos,{icon:L.icon({iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",iconSize:[32,32],iconAnchor:[16,32]})})
          .addTo(map).bindPopup(`<b>Therapist</b><br>${display_name}`).openPopup();
        map.setView(pos,7);
        const R=6371; const deg2rad=d=>d*Math.PI/180; const results=[];
        for(const m of markers){
          const lat1=pos[0],lon1=pos[1],lat2=m.marker.getLatLng().lat,lon2=m.marker.getLatLng().lng;
          const dLat=deg2rad(lat2-lat1),dLon=deg2rad(lon2-lon1);
          const a=Math.sin(dLat/2)**2+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
          const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
          results.push({name:m.name,dist:(R*c).toFixed(1)});
        }
        results.sort((a,b)=>a.dist-b.dist);
        let html=`<b>Distances from ${display_name} (closest first):</b><br><br>`;
        for(const r of results)html+=`${r.name} ‚Äî <b>${r.dist} km</b><br>`;
        document.getElementById("distanceResults").innerHTML=html;
      }catch(e){alert("Search failed");}
    };

    // üîÑ socket listeners
    socket.on("currentWorkers",ws=>ws.forEach(w=>addWorkerToUI(w)));
    socket.on("workerAdded",w=>addWorkerToUI(w));
    socket.on("workerRemoved",w=>removeWorkerFromUI(w));
    socket.on("allCleared",()=>clearAllUI());
  });
  </script>
</body>
</html>
