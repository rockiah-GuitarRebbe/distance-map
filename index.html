<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shared Distance Map ‚Äî Focus View</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { margin:0; display:flex; height:100vh; font-family:system-ui,Arial,sans-serif; }
    .sidebar { width:25%; min-width:260px; background:#f8f8f8; border-right:1px solid #ccc; display:flex; flex-direction:column; }
    #map { flex:1; height:100vh; }
    header { padding:10px; background:#fafafa; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; }
    #facilityList { list-style:none; padding:10px; margin:0; overflow-y:auto; flex:1; font-size:14px; }
    #facilityList li { padding:5px; border-bottom:1px solid #eee; cursor:pointer; }
    #facilityList li:hover { background:#eef; }
    button { border:none; border-radius:5px; padding:6px 10px; background:#0078d4; color:white; cursor:pointer; }
    button:hover { background:#005fa3; }
    .delete-btn { background:transparent; color:#d33; font-size:18px; border:none; cursor:pointer; padding:0 4px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <header>
      <h3>Clients</h3>
      <div>
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" />
        <button id="uploadExcelBtn">üìÇ Excel</button>
        <button id="clearListBtn" style="background:#e74c3c;">üßπ Clear</button>
      </div>
    </header>

    <div style="padding:10px; border-bottom:1px solid #ddd;">
      <label><b>Therapist Location:</b></label><br />
      <input id="therapistInput" placeholder="Enter ZIP or address" style="width:90%; padding:6px;" />
      <div style="margin-top:6px; display:flex; gap:5px;">
        <button id="therapistBtn">üìç Show</button>
        <button id="clearTherapistBtn" style="background:#888;">üßç‚Äç‚ôÄÔ∏è Clear</button>
      </div>
    </div>

    <div id="distanceResults" style="padding:10px; overflow-y:auto; flex:1; font-size:14px;">
      <i>No therapist selected.</i>
    </div>
  </div>
  <div id="map"></div>

  <script>
    const socket = io(window.location.origin, { transports: ["websocket", "polling"] });
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let therapistMarker = null;
    let clientMarker = null;
    const clients = [];

    // Upload Excel
    document.getElementById("uploadExcelBtn").onclick = () => document.getElementById("excelInput").click();
    document.getElementById("excelInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        clients.length = 0;
        rows.forEach(r => {
          const keys = Object.keys(r);
          if (keys.length >= 2) clients.push({ name: r[keys[0]], address: r[keys[1]] });
        });
        renderClientList();
      };
      reader.readAsArrayBuffer(file);
    });

    // Show therapist
    document.getElementById("therapistBtn").onclick = async () => {
      const q = document.getElementById("therapistInput").value.trim();
      if (!q) return alert("Please enter a ZIP code or address.");
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (!data.length) return alert("Address not found.");
      const { lat, lon, display_name } = data[0];
      if (therapistMarker) map.removeLayer(therapistMarker);
      therapistMarker = L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
          iconSize: [32, 32], iconAnchor: [16, 32]
        })
      }).addTo(map).bindPopup(`<b>Therapist</b><br>${display_name}`).openPopup();
      map.setView([lat, lon], 7);

      // Calculate distances
      await calculateDistances(lat, lon, display_name);
    };

    // Clear therapist + distances
    document.getElementById("clearTherapistBtn").onclick = () => {
      if (therapistMarker) { map.removeLayer(therapistMarker); therapistMarker = null; }
      if (clientMarker) { map.removeLayer(clientMarker); clientMarker = null; }
      document.getElementById("distanceResults").innerHTML = "<i>No therapist selected.</i>";
    };

    // Clear all
    document.getElementById("clearListBtn").onclick = () => {
      if (!confirm("Clear all clients and therapist?")) return;
      if (therapistMarker) { map.removeLayer(therapistMarker); therapistMarker = null; }
      if (clientMarker) { map.removeLayer(clientMarker); clientMarker = null; }
      clients.length = 0;
      document.getElementById("distanceResults").innerHTML = "<i>No therapist selected.</i>";
      document.getElementById("therapistInput").value = "";
    };

    // Calculate and show distances
    async function calculateDistances(lat, lon, display_name) {
      const deg2rad = d => d * Math.PI / 180;
      const R = 6371;
      const enriched = [];

      for (const c of clients) {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=us&q=${encodeURIComponent(c.address)}`);
          const data = await res.json();
          if (!data.length) continue;
          const { lat: lat2, lon: lon2 } = data[0];
          const dLat = deg2rad(lat2 - lat);
          const dLon = deg2rad(lon2 - lon);
          const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
          const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          enriched.push({ ...c, lat: lat2, lon: lon2, dist: dist.toFixed(1) });
        } catch (err) {
          console.warn("Failed for", c.address);
        }
      }

      enriched.sort((a,b)=>a.dist-b.dist);
      renderDistanceList(enriched, display_name);
    }

    function renderDistanceList(list, fromName) {
      const div = document.getElementById("distanceResults");
      if (!list.length) {
        div.innerHTML = `<i>No clients found.</i>`;
        return;
      }
      let html = `<b>Distances from ${fromName}:</b><br><br><ul id="facilityList">`;
      list.forEach(c => {
        html += `<li data-lat="${c.lat}" data-lon="${c.lon}" data-name="${c.name}" data-address="${c.address}">${c.name} ‚Äî <b>${c.dist} km</b></li>`;
      });
      html += "</ul>";
      div.innerHTML = html;

      // Click to show pin
      div.querySelectorAll("li").forEach(li => {
        li.addEventListener("click", () => {
          if (clientMarker) map.removeLayer(clientMarker);
          const { lat, lon, name, address } = li.dataset;
          clientMarker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png",
              iconSize: [32, 32],
              iconAnchor: [16, 32]
            })
          }).addTo(map).bindPopup(`<b>${name}</b><br>${address}`).openPopup();
          map.setView([lat, lon], 9);
        });
      });
    }

    function renderClientList() {
      document.getElementById("distanceResults").innerHTML = `<i>${clients.length} clients loaded. Enter a therapist to calculate distances.</i>`;
    }
  </script>
</body>
</html>
