<!-- --- index.html --- -->
<!-- 2) ADD this small activity area in the sidebar (e.g., under the Filters row) -->
<div class="row" style="margin:6px 0;">
  <div id="activityFeed" style="width:100%;"></div>
</div>

<!-- 3) ADD these styles (optional nicer look) inside <style> -->
<style>
  .act { padding:6px 8px; border:1px solid #e5e5e5; border-radius:8px; background:#fff; margin-bottom:6px; }
  .act b { font-weight:600; }
  .act small { color:#666; }
  .act progress { width:100%; height:10px; }
</style>

<script>
// 4) ADD near other top-level vars in <script>
let myName = "User";

// 5) AFTER you create the socket, set a friendly name once connected
socket.on("connect", () => {
  const saved = localStorage.getItem("displayName");
  myName = saved || `User-${socket.id.slice(0,5)}`;
  localStorage.setItem("displayName", myName);
});

// 6) EMIT activity during uploads
//    Replace ONLY the relevant spots inside your existing fileInput handler:

// right after: importStatus.textContent = "Parsing file…";
socket.emit("activity", { type: "uploadStart", by: myName, total: 0 });

// after you get `rows` (post readAnyTable + cleanup), set total:
socket.emit("activity", { type: "uploadStart", by: myName, total: rows.length });

// inside geocodeInBatches progress callback, throttle emits:
let _lastProgressEmit = 0;
const results = await geocodeInBatches(rows, 2, (done, total) => {
  importProgress.value = Math.floor((done / total) * 100);
  const now = Date.now();
  if (now - _lastProgressEmit > 500 || done === total) {
    _lastProgressEmit = now;
    socket.emit("activity", { type: "uploadProgress", by: myName, done, total });
  }
});

// after computing added/failed:
socket.emit("activity", { type: "uploadDone", by: myName, added, failed });

// 7) RENDER activity feed on every client
const activityFeed = document.getElementById("activityFeed");
const activeUploads = new Map(); // key: by  -> { done,total, ts }
socket.on("activity", (a) => {
  if (!activityFeed) return;
  if (a.type === "uploadStart") {
    activeUploads.set(a.by, { done: 0, total: a.total, ts: a.ts });
  } else if (a.type === "uploadProgress") {
    const cur = activeUploads.get(a.by) || { done: 0, total: a.total, ts: a.ts };
    cur.done = a.done; cur.total = a.total; cur.ts = a.ts;
    activeUploads.set(a.by, cur);
  } else if (a.type === "uploadDone") {
    // print a final line item and clear from active list
    renderActivityLine(`${a.by} finished import — added ${a.added}, failed ${a.failed}`, true);
    activeUploads.delete(a.by);
  } else {
    // generic: show as a line
    renderActivityLine(`${a.by}: ${a.type}`, true);
  }
  renderActiveUploads();
});

function renderActiveUploads() {
  // clear and re-render actives (progress bars) + keep last few finished messages
  const finished = Array.from(activityFeed.querySelectorAll(".act[data-finished='1']")).slice(-5);
  activityFeed.innerHTML = "";
  // active progress cards
  for (const [by, s] of activeUploads.entries()) {
    const pct = s.total ? Math.floor((s.done / s.total) * 100) : 0;
    const div = document.createElement("div");
    div.className = "act";
    div.innerHTML = `
      <div><b>${escapeHtml(by)}</b> is importing… <small>${s.done}/${s.total}</small></div>
      <progress max="100" value="${pct}"></progress>
    `;
    activityFeed.appendChild(div);
  }
  // append recent finished messages
  for (const el of finished) activityFeed.appendChild(el);
}

function renderActivityLine(text, finished=false) {
  const div = document.createElement("div");
  div.className = "act";
  if (finished) div.setAttribute("data-finished","1");
  div.textContent = text;
  activityFeed.appendChild(div);
  // trim to last ~8 items
  const lines = activityFeed.querySelectorAll(".act[data-finished='1']");
  if (lines.length > 8) activityFeed.removeChild(lines[0]);
}

// reuse your existing escapeHtml if present; else:
function escapeHtml(str) {
  return String(str ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
</script>
