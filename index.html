<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Distance Map ‚Äî Shared Therapist + Workers (Full Sync)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial, sans-serif; display: flex; }
    .sidebar {
      width: 300px; border-right: 1px solid #ddd; background: #f8f8f8;
      display: flex; flex-direction: column;
    }
    header {
      padding: 10px; border-bottom: 1px solid #ddd; background: #fafafa;
      display: flex; justify-content: space-between; align-items: center; gap: 6px;
    }
    #facilityList {
      list-style: none; margin: 0; padding: 10px; overflow-y: auto; flex: 1;
    }
    #facilityList li {
      display: flex; align-items: center; justify-content: flex-start;
      gap: 5px; border-bottom: 1px solid #eee; padding: 3px 0;
    }
    #map { flex: 1; }
    button {
      cursor: pointer; border: none; border-radius: 5px; padding: 5px 9px;
      background: #0078d4; color: white; font-size: 13px;
    }
    button:hover { background: #005fa3; }
    .delete-btn { background: transparent; color: #d33; border: none; font-size: 18px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="sidebar">
    <header>
      <h3 style="margin:0;">Workers</h3>
      <div>
        <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none" />
        <button id="uploadExcelBtn">üìÇ Excel</button>
        <button id="clearListBtn" style="background:#e74c3c;">üßπ Clear</button>
      </div>
    </header>

    <div style="padding:10px; border-bottom:1px solid #ddd;">
      <label><b>Therapist Location:</b></label><br />
      <input id="therapistInput" placeholder="Enter ZIP or address" style="width:90%; padding:5px;" />
      <div style="margin-top:6px; display:flex; gap:5px;">
        <button id="therapistBtn">üìç Show</button>
        <button id="clearTherapistBtn" style="background:#888;">üßç Clear</button>
      </div>
    </div>

    <div id="distanceResults" style="padding:10px; font-size:14px; overflow-y:auto; max-height:180px;">
      <i>No therapist selected.</i>
    </div>

    <ul id="facilityList"></ul>
  </div>

  <div id="map"></div>

  <script>
  const socket = io(window.location.origin, { transports: ["websocket", "polling"] });
  const map = L.map('map').setView([39.8283, -98.5795], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

  const markers = [];
  let therapistMarker = null;
  let cancelUpload = false;

  // --- Excel Upload ---
  document.getElementById("uploadExcelBtn").onclick = () =>
    document.getElementById("excelInput").click();

  document.getElementById("excelInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (evt) => {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      cancelUpload = false;
      for (const row of json) {
        if (cancelUpload) break;
        const name = row[Object.keys(row)[0]];
        const address = row[Object.keys(row)[1]];
        if (name && address) socket.emit("addWorker", { name, address });
        await new Promise(r => setTimeout(r, 500)); // smoother pacing
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // --- Add Worker Marker ---
  function addWorker(worker) {
    if (document.querySelector(`li[data-name="${worker.name}"]`)) return;
    const li = document.createElement("li");
    li.dataset.name = worker.name;
    li.textContent = `${worker.name} ‚Äî ${worker.address}`;
    document.getElementById("facilityList").appendChild(li);

    fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(worker.address)}`)
      .then(r => r.json())
      .then(data => {
        if (cancelUpload || !data.length) return;
        const { lat, lon } = data[0];
        const marker = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${worker.name}</b><br>${worker.address}`);
        markers.push({ ...worker, marker });
      });
  }

  // --- Show Therapist and sync ---
  document.getElementById("therapistBtn").addEventListener("click", async () => {
    const query = document.getElementById("therapistInput").value.trim();
    if (!query) return alert("Enter ZIP or address");
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query + ", USA")}`);
    const data = await res.json();
    if (!data.length) return alert("Not found");
    const { lat, lon, display_name } = data[0];
    showTherapist(lat, lon, display_name);
    socket.emit("setTherapist", { lat, lon, display_name });
  });

  // --- Clear Therapist ---
  document.getElementById("clearTherapistBtn").addEventListener("click", () => {
    if (therapistMarker) {
      map.removeLayer(therapistMarker);
      therapistMarker = null;
      document.getElementById("distanceResults").innerHTML = "<i>No therapist selected.</i>";
      socket.emit("clearTherapist");
    }
  });

  // --- Show Therapist Marker ---
  function showTherapist(lat, lon, display_name) {
    if (therapistMarker) map.removeLayer(therapistMarker);
    therapistMarker = L.marker([lat, lon], {
      icon: L.icon({
        iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      })
    }).addTo(map).bindPopup(`<b>Therapist</b><br>${display_name}`).openPopup();
    map.setView([lat, lon], 7);

    // Compute distances
    const R = 6371, deg2rad = d => d * Math.PI / 180;
    const results = markers.map(m => {
      const lat2 = m.marker.getLatLng().lat, lon2 = m.marker.getLatLng().lng;
      const dLat = deg2rad(lat2 - lat), dLon = deg2rad(lon2 - lon);
      const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return { name: m.name, dist: (R * c).toFixed(1) };
    }).sort((a,b) => a.dist - b.dist);

    document.getElementById("distanceResults").innerHTML =
      `<b>From ${display_name}:</b><br>` + results.map(r => `${r.name} ‚Äî <b>${r.dist} km</b>`).join("<br>");
  }

  // --- Clear All (stop uploads + sync clear) ---
  document.getElementById("clearListBtn").addEventListener("click", () => {
    if (!confirm("Clear all workers and therapist for everyone?")) return;
    cancelUpload = true;
    socket.emit("cancelUploads");
    socket.emit("clearAll");
  });

  // --- SOCKET EVENTS ---
  socket.on("workerAdded", addWorker);
  socket.on("allCleared", () => {
    cancelUpload = true;
    document.getElementById("facilityList").innerHTML = "";
    markers.forEach(m => map.removeLayer(m.marker));
    markers.length = 0;
    if (therapistMarker) map.removeLayer(therapistMarker);
    therapistMarker = null;
    document.getElementById("distanceResults").innerHTML = "<i>No therapist selected.</i>";
  });
  socket.on("currentWorkers", (list) => list.forEach(addWorker));
  socket.on("therapistUpdated", (data) => showTherapist(data.lat, data.lon, data.display_name));
  socket.on("therapistCleared", () => {
    if (therapistMarker) map.removeLayer(therapistMarker);
    therapistMarker = null;
    document.getElementById("distanceResults").innerHTML = "<i>No therapist selected.</i>";
  });
  socket.on("currentTherapist", (data) => {
    if (data) showTherapist(data.lat, data.lon, data.display_name);
  });
  socket.on("cancelUploads", () => {
    cancelUpload = true;
    console.warn("üö´ Uploads cancelled by another user");
  });
  </script>
</body>
</html>
