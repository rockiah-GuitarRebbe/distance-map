<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Facility Distance Viewer (with Estimated Drive Time)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      :root { --brand:#3f51b5; }
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
      h2 { background: var(--brand); color: #fff; padding: 10px 14px; margin: 0; }
      #layout { display: grid; grid-template-columns: 360px 1fr; gap: 10px; }
      #left {
        background:#fff; margin:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1);
        padding:12px; height: calc(100vh - 70px); overflow:auto;
      }
      #right { margin:10px; }
      #map { height: calc(100vh - 70px); width: 100%; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); }
      .section-title { font-weight:bold; margin:10px 0 6px; color:#333; }
      .row { display:flex; gap:8px; }
      input[type="file"]{ width:100%; }
      input[type="text"]{ flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; }
      button {
        padding:10px 12px; border:none; border-radius:8px; cursor:pointer;
        background: var(--brand); color:#fff; font-weight:600;
      }
      button.secondary { background:#e0e0e0; color:#333; }
      #loadedList, #sortedList {
        font-size:14px; line-height:1.4; background:#fafafa; border:1px solid #eee;
        border-radius:8px; padding:8px; max-height:240px; overflow:auto;
      }
      .closest { background:#fff7e6; border-left:4px solid #f5a623; padding-left:8px; border-radius:6px; }
      .muted { color:#666; }
    </style>
  </head>
  <body>
    <h2>üìç Facility Distance Viewer (Estimated Driving Time)</h2>
    <div id="layout">
      <div id="left">
        <div class="section-title">Upload facilities (Excel: <em>name</em>, <em>address</em>)</div>
        <input type="file" id="fileInput" accept=".xlsx, .xls" />

        <div class="section-title">Worker search</div>
        <div class="row" style="margin-bottom:8px;">
          <input type="text" id="workerInput" placeholder="Enter worker address (e.g., 90210 or 15 Summit Ave, Monsey, NY)" />
          <button id="findBtn">Find Closest</button>
        </div>
        <div class="row" style="margin-bottom:12px;">
          <button id="clearBtn" class="secondary">Clear Map</button>
        </div>

        <div class="section-title">Loaded facilities</div>
        <div id="loadedList" class="muted">No file loaded yet.</div>

        <div class="section-title">Results (shortest drive ‚Üí longest)</div>
        <div id="sortedList" class="muted">Enter a worker address to see distances.</div>
      </div>

      <div id="right">
        <div id="map"></div>
      </div>
    </div>

    <script>
      let map;
      let allFacilities = [];
      let workerMarker = null;
      let closestHalo = null;

      function initMap() {
        map = L.map("map").setView([39.8283, -98.5795], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);
      }

      // ===== FILE HANDLING =====
      document.getElementById("fileInput").addEventListener("change", handleFile);
      function handleFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        clearMap(true);

        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet);

          allFacilities = rows.map(r => ({ name: r.name || "Unnamed", address: r.address || "" }));

          document.getElementById("loadedList").innerHTML =
            `Loaded ${allFacilities.length} facilities:<br>` +
            allFacilities.map(f => `${f.name} ‚Äî ${f.address}`).join("<br>");

          showFacilitiesOnMap();
        };
        reader.readAsArrayBuffer(file);
      }

      // ===== GEOCODER (Photon, free) =====
     async function geocodeAddress(address) {
  // üßπ Clean up and normalize addresses before searching
  let cleaned = address
    .replace(/\s+/g, " ")                   // collapse multiple spaces
    .replace(/,+/g, ",")                    // remove double commas
    .replace(/\bUSA\b/gi, "United States")  // expand country name
    .replace(/\bRd\b/gi, "Road")
    .replace(/\bAve\b/gi, "Avenue")
    .replace(/\bBlvd\b/gi, "Boulevard")
    .replace(/\bCt\b/gi, "Court")
    .replace(/\bDr\b/gi, "Drive")
    .replace(/\bLn\b/gi, "Lane")
    .replace(/\bSt\b/gi, "Street")
    .replace(/\bVA\b(?!\w)/gi, "Virginia")  // make states explicit
    .replace(/\bNC\b(?!\w)/gi, "North Carolina")
    .replace(/\bMD\b(?!\w)/gi, "Maryland")
    .replace(/\bPA\b(?!\w)/gi, "Pennsylvania")
    .replace(/\bNY\b(?!\w)/gi, "New York")
    .replace(/\bMA\b(?!\w)/gi, "Massachusetts")
    .replace(/\bCA\b(?!\w)/gi, "California")
    + ", United States";

  async function fetchPhoton(query) {
    const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=1`;
    const resp = await fetch(url);
    return resp.json();
  }

  try {
    // üîç 1Ô∏è‚É£ Full address
    let data = await fetchPhoton(cleaned);
    if (data?.features?.length > 0) {
      const [lng, lat] = data.features[0].geometry.coordinates;
      return [lat, lng];
    }

    // üîç 2Ô∏è‚É£ Simplified (strip house number)
    const simplified = cleaned.replace(/^\d+\s*/, "");
    data = await fetchPhoton(simplified);
    if (data?.features?.length > 0) {
      const [lng, lat] = data.features[0].geometry.coordinates;
      return [lat, lng];
    }

    // üîç 3Ô∏è‚É£ City-level fallback
    const parts = cleaned.split(/[, ]+/);
    const stateZip = parts.slice(-2).join(" ");
    const cityOnly = parts.slice(-3, -1).join(" ");
    const fallback = `${cityOnly} ${stateZip}, United States`;
    data = await fetchPhoton(fallback);
    if (data?.features?.length > 0) {
      const [lng, lat] = data.features[0].geometry.coordinates;
      return [lat, lng];
    }
  } catch (e) {
    console.warn("Geocoding failed for:", address);
  }

  return null;
}


      async function showFacilitiesOnMap() {
        for (let i = 0; i < allFacilities.length; i++) {
          const f = allFacilities[i];
          const coords = await geocodeAddress(f.address);
          if (coords) {
            f.coords = coords;
            f.marker = L.marker(coords).addTo(map).bindPopup(`<b>${f.name}</b><br>${f.address}`);
          } else {
            f.coords = null;
          }
          await new Promise(r => setTimeout(r, 800));
        }
        const group = L.featureGroup(allFacilities.filter(x => x.coords).map(x => x.marker));
        if (group.getLayers().length) map.fitBounds(group.getBounds().pad(0.2));
      }

      // ===== WORKER SEARCH =====
      document.getElementById("findBtn").addEventListener("click", onFindClosest);
      document.getElementById("workerInput").addEventListener("keydown", e => {
        if (e.key === "Enter") onFindClosest();
      });

      async function onFindClosest() {
        const addr = document.getElementById("workerInput").value.trim();
        if (!addr) return;

        const workerCoords = await geocodeAddress(addr);
        const listEl = document.getElementById("sortedList");

        if (!workerCoords) {
          listEl.innerHTML = `<span class="muted">Could not locate: ${addr}</span>`;
          return;
        }

        if (workerMarker) map.removeLayer(workerMarker);
        workerMarker = L.circleMarker(workerCoords, { radius: 8, weight: 2, color: "#f03", fillOpacity: 0.5 })
          .addTo(map)
          .bindPopup(`<b>Worker</b><br>${addr}`)
          .openPopup();
        map.setView(workerCoords, 9);

        const withCoords = allFacilities.filter(f => Array.isArray(f.coords));
        if (withCoords.length === 0) {
          listEl.innerHTML = `<span class="muted">No geocoded facilities to compare yet.</span>`;
          return;
        }

        // Calculate straight-line distance + estimated drive distance/time
        const distances = withCoords.map(f => {
          const km = haversine(workerCoords[0], workerCoords[1], f.coords[0], f.coords[1]);
          const mi = km * 0.621371;
          const drivingMi = mi * 1.3;               // assume 30% longer by roads
          const drivingTimeHr = drivingMi / 40.0;   // assume avg 40 mph
          const driveMins = drivingTimeHr * 60;
          return { name: f.name, address: f.address, km, mi, drivingMi, driveMins, marker: f.marker, coords: f.coords };
        }).sort((a, b) => a.driveMins - b.driveMins);

        // Highlight closest
        if (closestHalo) map.removeLayer(closestHalo);
        closestHalo = L.circle(distances[0].coords, { radius: 250, color: "#f5a623", weight: 3, fillOpacity: 0.1 }).addTo(map);
        distances[0].marker.openPopup();

        // Display sorted list
        const workerLine = `<div class="muted" style="margin-bottom:6px;">From worker: <b>${addr}</b></div>`;
        const rows = distances.map((d, i) => {
          const cls = i === 0 ? 'class="closest"' : "";
          const hrs = Math.floor(d.driveMins / 60);
          const mins = Math.round(d.driveMins % 60);
          const timeTxt = hrs > 0 ? `${hrs} hr ${mins} min` : `${mins} min`;
          return `<div ${cls} style="margin:6px 0; padding:6px;">
                    <div><b>${i + 1}. ${d.name}</b></div>
                    <div>${d.address}</div>
                    <div class="muted">~${d.drivingMi.toFixed(1)} mi ‚Äî est. ${timeTxt} drive</div>
                  </div>`;
        }).join("");
        listEl.innerHTML = workerLine + rows;
      }

      // Haversine formula (km)
      function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371, toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
      }

      // Clear map
      document.getElementById("clearBtn").addEventListener("click", () => clearMap(false));
      function clearMap(keepFacilitiesList) {
        allFacilities.forEach(f => { if (f.marker) map.removeLayer(f.marker); });
        allFacilities.forEach(f => { f.marker = null; f.coords = null; });
        if (workerMarker) { map.removeLayer(workerMarker); workerMarker = null; }
        if (closestHalo) { map.removeLayer(closestHalo); closestHalo = null; }
        document.getElementById("sortedList").innerHTML = '<span class="muted">Enter a worker address to see distances.</span>';
        if (!keepFacilitiesList) document.getElementById("loadedList").innerHTML = 'No file loaded yet.';
      }

      initMap();
    </script>
  </body>
</html>
