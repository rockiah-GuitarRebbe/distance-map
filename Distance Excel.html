<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Distance Map — Workers (Live)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 10px;
      background: #f3f3f3;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #facilityList {
      list-style: none;
      padding: 10px;
      margin: 0;
    }
    #facilityList li {
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      padding: 5px 0;
    }
    #map {
      height: 80vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <header>
    <h2>Loaded Workers</h2>
    <button id="addWorkerBtn">➕ Add Worker</button>
  </header>

  <ul id="facilityList"></ul>
  <div id="map"></div>

  <!-- Add Worker Popup -->
  <div id="addWorkerPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
   background:#fff; border:2px solid #ccc; border-radius:10px; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,0.2); z-index:9999;">
    <h3>Add Worker</h3>
    <label>Name:</label><br>
    <input id="workerName" placeholder="Enter name" style="width:250px;"><br><br>
    <label>Address:</label><br>
    <input id="workerAddress" placeholder="Enter address" style="width:250px;"><br><br>
    <button id="saveWorkerBtn">Add</button>
    <button id="cancelWorkerBtn">Cancel</button>
  </div>

  <script>
    const socket = io(); // connect to server

    // --- Initialize map ---
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = [];

    // --- Popup logic ---
    document.getElementById("addWorkerBtn").addEventListener("click", () => {
      document.getElementById("addWorkerPopup").style.display = "block";
    });
    document.getElementById("cancelWorkerBtn").addEventListener("click", () => {
      document.getElementById("addWorkerPopup").style.display = "none";
    });

    // --- Add worker locally and emit event ---
    document.getElementById("saveWorkerBtn").addEventListener("click", async () => {
      const name = document.getElementById("workerName").value.trim();
      const address = document.getElementById("workerAddress").value.trim();
      if (!name || !address) {
        alert("Please enter both name and address");
        return;
      }

      addWorker({ name, address });
      socket.emit("addWorker", { name, address });

      document.getElementById("addWorkerPopup").style.display = "none";
      document.getElementById("workerName").value = "";
      document.getElementById("workerAddress").value = "";
    });

    // --- Socket events ---
    socket.on("loadWorkers", (workers) => {
      workers.forEach(w => addWorker(w));
    });
    socket.on("workerAdded", (worker) => {
      addWorker(worker);
    });
    socket.on("workerDeleted", (worker) => {
      removeWorker(worker);
    });

    // --- Functions ---
    async function addWorker(worker) {
      if (document.querySelector(`li[data-name="${worker.name}"][data-address="${worker.address}"]`)) return;

      const list = document.getElementById("facilityList");
      const item = document.createElement("li");
      item.dataset.name = worker.name;
      item.dataset.address = worker.address;
      item.textContent = `${worker.name} — ${worker.address}`;

      const delBtn = document.createElement("button");
      delBtn.textContent = "❌";
      delBtn.style.marginLeft = "10px";
      delBtn.onclick = () => {
        socket.emit("deleteWorker", worker);
        removeWorker(worker);
      };
      item.appendChild(delBtn);
      list.appendChild(item);

      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(worker.address)}`);
        const data = await res.json();
        if (data.length > 0) {
          const lat = data[0].lat;
          const lon = data[0].lon;
          const marker = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${worker.name}</b><br>${worker.address}`);
          markers.push({ ...worker, marker });
          map.setView([lat, lon], 10);
        }
      } catch (err) {
        console.error("Address lookup failed:", err);
      }
    }

    function removeWorker(worker) {
      const list = document.getElementById("facilityList");
      const item = document.querySelector(`li[data-name="${worker.name}"][data-address="${worker.address}"]`);
      if (item) list.removeChild(item);

      const m = markers.find((x) => x.name === worker.name && x.address === worker.address);
      if (m) map.removeLayer(m.marker);
    }
  </script>
</body>
</html>
